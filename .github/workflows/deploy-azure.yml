name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - dev
      - master
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  AZURE_RESOURCE_GROUP: hospital-dashboard-rg
  CONTAINER_APP_NAME: signalsboard-api
  CONTAINER_ENV_NAME: signalsboard-env

jobs:
  # ===========================================
  # BUILD & PUSH - Docker image to GHCR
  # ===========================================
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image: ${{ steps.tag.outputs.full }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compute image tag
        id: tag
        run: |
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "full=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SHA_SHORT}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.tag.outputs.short }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Hospital.Api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image summary
        run: |
          echo "## Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | ${{ env.REGISTRY }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | ${{ env.IMAGE_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | ${{ steps.build.outputs.digest }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DEPLOY - To Azure Container Apps
  # ===========================================
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/master' && 'production' || 'staging' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Container Apps
        id: deploy
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            # Use image from build job
            IMAGE_TAG="${{ needs.build-and-push.outputs.image }}"
            echo "Deploying: $IMAGE_TAG"

            # Check if container app exists
            EXISTS=$(az containerapp show \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "name" -o tsv 2>/dev/null || echo "")

            if [ -z "$EXISTS" ]; then
              echo "Creating new Container App..."
              az containerapp create \
                --name ${{ env.CONTAINER_APP_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --environment ${{ env.CONTAINER_ENV_NAME }} \
                --image "$IMAGE_TAG" \
                --target-port 8080 \
                --ingress external \
                --min-replicas 0 \
                --max-replicas 1 \
                --cpu 0.25 \
                --memory 0.5Gi \
                --env-vars \
                  "ASPNETCORE_ENVIRONMENT=Production" \
                  "ConnectionStrings__DefaultConnection=${{ secrets.DB_CONNECTION_STRING }}"
            else
              echo "Updating existing Container App..."
              az containerapp update \
                --name ${{ env.CONTAINER_APP_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --image "$IMAGE_TAG"
            fi

            # Get the app URL
            FQDN=$(az containerapp show \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "properties.configuration.ingress.fqdn" -o tsv)

            echo "url=https://$FQDN" >> $GITHUB_OUTPUT
            echo "App URL: https://$FQDN"

      - name: Verify deployment
        run: |
          echo "Waiting for container to start..."
          sleep 30
          HEALTH_URL="${{ steps.deploy.outputs.url }}/health"
          echo "Checking: $HEALTH_URL"
          curl -f "$HEALTH_URL" -s --retry 5 --retry-delay 10 || echo "Health check pending"

      - name: Deployment summary
        run: |
          echo "## Container Apps Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.deploy.outputs.url }}/ |" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ steps.deploy.outputs.url }}/api/ |" >> $GITHUB_STEP_SUMMARY
          echo "| Swagger | ${{ steps.deploy.outputs.url }}/swagger/ |" >> $GITHUB_STEP_SUMMARY
          echo "| Health | ${{ steps.deploy.outputs.url }}/health |" >> $GITHUB_STEP_SUMMARY

